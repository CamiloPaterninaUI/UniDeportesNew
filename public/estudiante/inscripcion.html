<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inscripci贸n a Torneo</title>
<link rel="stylesheet" href="../css/style.css">
</head>
<body>
<nav class="menu-principal">
    <div class="logo">UniDeportes</div>
    <ul class="menu-lista">
        <li><a href="estudiante_dashboard.html">Volver al Dashboard</a></li>
        <li><a href="#" id="cerrar-sesion">Cerrar Sesi贸n</a></li>
    </ul>
</nav>

<main class="contenido">
    <h1>Inscribirse a Torneo</h1>
    <div id="info-torneo">Cargando torneo...</div>
    <div id="msg-inscripcion"></div>
    <button id="inscribirse-btn" class="btn-principal" style="display:none;">Inscribirse</button>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCGYWe2CcXLo0LJUVZNDK5ZEeBtU2aVjxw",
  authDomain: "proyecto-unibague.firebaseapp.com",
  projectId: "proyecto-unibague",
  storageBucket: "proyecto-unibague.firebasestorage.app",
  messagingSenderId: "68419956684",
  appId: "1:68419956684:web:cc4f156083423c489af769"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let usuarioActual = null;
let equipoExistente = null;

// ===========================
// Obtener torneoId desde URL
// ===========================
const params = new URLSearchParams(window.location.search);
const torneoId = params.get('torneoId');

// ===========================
// Protege la ruta y carga datos
// ===========================
onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = '../login.html';
  usuarioActual = user;

  const docRef = doc(db, 'usuarios', user.uid);
  const docSnap = await getDoc(docRef);
  if (!docSnap.exists() || docSnap.data().rol !== 'estudiante') {
    await signOut(auth);
    return window.location.href = '../login.html';
  }

  await cargarEquipo();
  await cargarTorneo();
});

// ===========================
// Cerrar sesi贸n
// ===========================
document.getElementById('cerrar-sesion').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = '../login.html';
});

// ===========================
// Cargar equipo
// ===========================
async function cargarEquipo() {
  const q = query(collection(db, 'equipos'), where('creador', '==', usuarioActual.uid));
  const snapshot = await getDocs(q);
  if (!snapshot.empty) {
    equipoExistente = snapshot.docs[0].data();
    equipoExistente.id = snapshot.docs[0].id;
  }
}

// ===========================
// Cargar datos del torneo
// ===========================
async function cargarTorneo() {
  const infoDiv = document.getElementById('info-torneo');
  const btn = document.getElementById('inscribirse-btn');

  if (!torneoId) {
    infoDiv.textContent = 'Torneo no especificado.';
    return;
  }

  const docRef = doc(db, 'torneos', torneoId);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists()) {
    infoDiv.textContent = 'Torneo no encontrado.';
    return;
  }

  const torneo = docSnap.data();
  infoDiv.innerHTML = `<strong>${torneo.nombre}</strong><br>
                       Deporte: ${torneo.deporte}<br>
                       Fecha inicio: ${torneo.fechaInicio?.toDate ? torneo.fechaInicio.toDate().toLocaleDateString('es-CO') : torneo.fechaInicio || 'Pendiente'}<br>
                       Estado: ${torneo.estado}`;

  if (equipoExistente) {
    btn.style.display = 'inline-block';
    btn.addEventListener('click', async () => {
      try {
        await addDoc(collection(db, 'inscripciones'), {
          estudianteUid: usuarioActual.uid,
          equipoId: equipoExistente.id,
          torneoId: torneoId,
          fechaInscripcion: new Date()
        });
        document.getElementById('msg-inscripcion').textContent = 'Inscripci贸n exitosa!';
        btn.disabled = true;
      } catch(e) {
        console.error(e);
        document.getElementById('msg-inscripcion').textContent = 'Error al inscribirse.';
      }
    });
  } else {
    document.getElementById('msg-inscripcion').textContent = 'Debes crear un equipo primero.';
  }
}
</script>
</body>
</html>
